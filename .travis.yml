dist: trusty
sudo: required
language: java
jdk:
  - openjdk8
  - oraclejdk8
# env:
#     - MONGODB_VER=mongodb-linux-x86_64-2.6.12 ANT_TEST=test               WIRED_TIGER=false
#     - MONGODB_VER=mongodb-linux-x86_64-3.0.14 ANT_TEST=test_mongo_storage WIRED_TIGER=false
#     - MONGODB_VER=mongodb-linux-x86_64-3.0.14 ANT_TEST=test_mongo_storage WIRED_TIGER=true
#     - MONGODB_VER=mongodb-linux-x86_64-3.2.12 ANT_TEST=test_mongo_storage WIRED_TIGER=false
#     - MONGODB_VER=mongodb-linux-x86_64-3.2.12 ANT_TEST=test_mongo_storage WIRED_TIGER=true
#     - MONGODB_VER=mongodb-linux-x86_64-3.4.2  ANT_TEST=test_mongo_storage WIRED_TIGER=false
#     - MONGODB_VER=mongodb-linux-x86_64-3.4.2  ANT_TEST=test_mongo_storage WIRED_TIGER=true

before_install:
  - sudo apt-get -qq update
  - sudo apt-get install -y ant-optional

install:
  - export CURDIR=$PWD
  - cd ..
  - git clone https://github.com/kbase/jars
  - export JARSDIR=`pwd`/jars/lib/jars/

  - export LAST_VER=last-956
  - wget -O $LAST_VER.zip https://www.dropbox.com/s/mj528m2ylp0nty5/$LAST_VER.zip?dl=1
  - unzip $LAST_VER.zip
  - cd $LAST_VER
  - make
  - export PATH=$PATH:$PWD/src
  - cd $CURDIR

script:
#  - cd ..
#  - wget http://fastdl.mongodb.org/linux/$MONGODB_VER.tgz
#  - tar xfz $MONGODB_VER.tgz
#  - export MONGOD=`pwd`/$MONGODB_VER/bin/mongod
#  - cd -
#  - cp -n test.cfg.example test.cfg
#  - sed -i "s#^test.temp.dir=.*#test.temp.dir=temp_test_dir#" test.cfg
#  - sed -i "s#^test.mongo.exe.*#test.mongo.exe=$MONGOD#" test.cfg
#  - sed -i "s#^test.mongo.wired_tiger.*#test.mongo.wired_tiger=$WIRED_TIGER#" test.cfg
#  - sed -i "s#^test.jars.dir=.*#test.jars.dir=$JARSDIR#" test.cfg
#  - cat test.cfg
  - ant test

jobs:
  include:
    - stage: deploy
      env: # The following are secure declarations for DOCKER_USER, DOCKER_PASS
        - secure: "tS3oRUDjWluDIenC8wW9xRjD8wZVIgxE7cbVsntfrCHx6Og3JxBYRwcozBLyIyIBYMNpvPd2bcccVOvK+aJATYW7SOvZ3XETS/UH/bwfE1ePDyUHrRDkhYJOwtmbQwiVSoM3sSltb8GlvFiUMKVsLI/MvIl02ebDZt2h4IzjiebdOHbJ1nv14oxQ/LjfeI4YuyYYS+8aK0Fp6+k2xEE+eB0C+62MRd5D2YRuLKCxzDw/dlLjTF7yJXbHPCREIH3YZ7/9/A99xET2vOsj45UzLmcaeyuglhGpUN/uOpJ5dB2AI5i0t/HggHU0/xYUbk60vK7jIBXXtfKEgl7Xk2GyrlVjnf+uKS4h2ZzyxH85hkyPMUFQ7aVtSF5qmv3Q7Nxl1jzk2KBgT2/2lR0vfvPXU0Wrz5UbSwWbX4LBjSsnzC1yHTrVUTiUl5Y5quXNoOFm/Pl4g4B7K2iLEKJrV4/YDHBp4uWIMe24Q5qFxLxXhUsGhmuUG9LfHitMe32jn7tgeohk/2qvm0/SHUp3VdEHVef0/9O+saRoyIGgeYDIVGqTu1oYo0FdYIoxjBnpuWMiKTIHMJb0r94h05+TqZCxQeVl+wRCRqxCoSwuEolTvJBkvIb8dybIZkn6rfvXkdCuPzcp56HMedxUsSQ/TNEBhjPImI4fkC2mdaa4B7i2XMI="
        - secure: "S8SrZGPwYWf3gctu38qj4nBYO28qkgJblkWoANMxkiLdCCOc9Ulj1Ge54gDxc78g2xhzXiVHdMPbVvRG3ZusbkFJBFaXhu47p5GhKea4m/5KVovh2yLy/lt368tcNRUL8NeC4iZ/mDIX/hz0f1vd7v4Ss9NWhJwz4tBEzB7BrT2JzNEvTjM18p+JXmjVL8t7/a0NeTE5ey2uWsTeIFFrJT1fJ7X8IdmgDVO43k9+0TbmIU/TsG7gf5VkYg0Ehe+34kicOyIXijUBAU1OuDbP8uBU7MFrwLeSIpYua52m+OFVqEQ0Nm4AWaM1np6zfX1HM+1DYtIHBQgEo2Qxfjf3nctxmRlv8SGejRBh1ZqdAX1ukTU1CvRZu8qafH25T5xmX6AolSd6QFg+QUqPfuaiYN2RBHZNh7lT72J7cVfugfJ0peJi6UpaLMX8e+kNqZXivig9LGk3TcbqfkVaY32xApCqoSyV+2gzbeWr0s+HWdoSHI6T6ThF1zMCpU9QalIsWpOAaS1U8UajyTalpXXUJ5AIg3zd2DhWbH+ofrWAwJ2lDaYOjlxywr2Q74iQOYYmiqcfsaGUBsCiGcboxBj2SsIIOkazSt2W/dgWIzltyklm13++QN5jwXlZE0IUaIExVZqnznvnR6wQaNGdfYEF3BGVJAxUNBJjeU2cb8w7XM4="
      script: # Only push to dockerhub if this isn't a PR and we're updating master or develop
        - docker pull kbase/kb_jre
        - ant docker_image
        - IMAGE_NAME=kbase/gene_homology build/push2dockerhub.sh
after_success:
  - ls test-reports
  - bash <(curl -s https://codecov.io/bash) -f test-reports/coverage-report.xml
